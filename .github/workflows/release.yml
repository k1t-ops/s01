name: Build and Release s01 Binaries

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.0)"
        required: true
        default: "v0.0.0"
      architectures:
        description: "Architectures to build (comma-separated: amd64,arm64,arm)"
        required: true
        default: "amd64,arm64,arm"
      prerelease:
        description: "Mark as pre-release"
        type: boolean
        required: false
        default: false

env:
  GO_VERSION: "1.21"
  CGO_ENABLED: 0

jobs:
  # Build matrix for multiple architectures and platforms
  build-matrix:
    name: Build ${{ matrix.os }}-${{ matrix.arch }} binaries
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # Linux builds
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            component: server
          - os: linux
            arch: arm64
            runner: ubuntu-latest
            component: server
          - os: linux
            arch: arm
            runner: ubuntu-latest
            component: server
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            component: client
          - os: linux
            arch: arm64
            runner: ubuntu-latest
            component: client
          - os: linux
            arch: arm
            runner: ubuntu-latest
            component: client
          # macOS builds
          - os: darwin
            arch: amd64
            runner: macos-13
            component: server
          - os: darwin
            arch: arm64
            runner: macos-14
            component: server
          - os: darwin
            arch: amd64
            runner: macos-13
            component: client
          - os: darwin
            arch: arm64
            runner: macos-14
            component: client
      fail-fast: false

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Set architecture variables
        id: arch
        run: |
          case "${{ matrix.arch }}" in
            amd64)
              echo "GOARCH=amd64" >> $GITHUB_ENV
              echo "arch_name=amd64" >> $GITHUB_OUTPUT
              ;;
            arm64)
              echo "GOARCH=arm64" >> $GITHUB_ENV
              echo "arch_name=arm64" >> $GITHUB_OUTPUT
              ;;
            arm)
              echo "GOARCH=arm" >> $GITHUB_ENV
              echo "GOARM=7" >> $GITHUB_ENV
              echo "arch_name=armv7" >> $GITHUB_OUTPUT
              ;;
          esac
          echo "GOOS=${{ matrix.os }}" >> $GITHUB_ENV

      - name: Build ${{ matrix.component }} binary
        working-directory: ${{ matrix.component }}
        run: |
          echo "Building s01-${{ matrix.component }} for ${{ matrix.os }}-${{ matrix.arch }}..."

          # Set binary extension for Windows (if we add it later)
          BINARY_NAME="s01-${{ matrix.component }}"

          # Build with version information
          go mod tidy
          go build -a -installsuffix cgo \
            -ldflags="-w -s -X main.version=${{ steps.version.outputs.version }} -X main.buildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.gitCommit=${{ github.sha }}" \
            -o "${BINARY_NAME}" .

          # Verify binary
          file "${BINARY_NAME}" || ls -la "${BINARY_NAME}"

          echo "Binary built successfully for ${{ matrix.os }}-${{ matrix.arch }}"

      - name: Package binary
        working-directory: ${{ matrix.component }}
        run: |
          BINARY_NAME="s01-${{ matrix.component }}"
          PACKAGE_NAME="s01-${{ matrix.component }}-${{ matrix.os }}-${{ steps.arch.outputs.arch_name }}"

          # Create package
          tar -czf "${PACKAGE_NAME}.tar.gz" "${BINARY_NAME}"

          # Generate individual checksum
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "${PACKAGE_NAME}.tar.gz" > "${PACKAGE_NAME}.tar.gz.sha256"
          else
            # macOS uses shasum
            shasum -a 256 "${PACKAGE_NAME}.tar.gz" > "${PACKAGE_NAME}.tar.gz.sha256"
          fi

          echo "Package created: ${PACKAGE_NAME}.tar.gz"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.component }}
          path: |
            ${{ matrix.component }}/s01-${{ matrix.component }}-${{ matrix.os }}-${{ steps.arch.outputs.arch_name }}.tar.gz
            ${{ matrix.component }}/s01-${{ matrix.component }}-${{ matrix.os }}-${{ steps.arch.outputs.arch_name }}.tar.gz.sha256

  # Create release with all artifacts
  create-release:
    name: Create Release
    needs: build-matrix
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize release files
        run: |
          mkdir -p release
          find artifacts -name "*.tar.gz" -exec cp {} release/ \;
          find artifacts -name "*.sha256" -exec cp {} release/ \;

          # Create combined checksums file
          cd release
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum *.tar.gz > checksums.txt
          else
            # macOS compatibility (shouldn't happen in ubuntu runner, but just in case)
            shasum -a 256 *.tar.gz > checksums.txt
          fi

          echo "Release files:"
          ls -la

      - name: Filter architectures (for manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [[ "${{ github.event.inputs.architectures }}" != "amd64,arm64,arm" ]]; then
            echo "Filtering architectures: ${{ github.event.inputs.architectures }}"

            cd release
            # Keep only specified architectures
            IFS=',' read -ra ARCHS <<< "${{ github.event.inputs.architectures }}"
            for file in *.tar.gz; do
              keep=false
              for arch in "${ARCHS[@]}"; do
                case "$arch" in
                  amd64) [[ "$file" == *"amd64"* ]] && keep=true ;;
                  arm64) [[ "$file" == *"arm64"* ]] && keep=true ;;
                  arm) [[ "$file" == *"armv7"* ]] && keep=true ;;
                esac
              done

              if [[ "$keep" == "false" ]]; then
                echo "Removing $file (architecture not selected)"
                rm -f "$file" "${file}.sha256"
              fi
            done

            # Regenerate checksums
            if command -v sha256sum >/dev/null 2>&1; then
              sha256sum *.tar.gz > checksums.txt
            else
              shasum -a 256 *.tar.gz > checksums.txt
            fi
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.build-matrix.outputs.version }}"

          cat > release_notes.md << EOF
          # s01 ${VERSION}

          üöÄ **Multi-Architecture Release** supporting Linux on multiple architectures!

          ## üì¶ What's Included

          This release contains precompiled binaries for multiple platforms:

          ### s01 Server
          $(find release -name "s01-server-*.tar.gz" | sed 's/release\///' | sed 's/^/- **/' | sed 's/$/** - Server binary/')

          ### s01 Client
          $(find release -name "s01-client-*.tar.gz" | sed 's/release\///' | sed 's/^/- **/' | sed 's/$/** - Client binary/')

          ### Checksums
          - **checksums.txt** - SHA256 checksums for all binaries

          ## üèóÔ∏è Supported Platforms & Architectures

          ### Linux
          | Architecture | Description | Binary Suffix |
          |--------------|-------------|---------------|
          | **amd64** | 64-bit Intel/AMD | \`linux-amd64\` |
          | **arm64** | 64-bit ARM (AWS Graviton, etc.) | \`linux-arm64\` |
          | **armv7** | 32-bit ARM (Raspberry Pi) | \`linux-armv7\` |

          ### macOS
          | Architecture | Description | Binary Suffix |
          |--------------|-------------|---------------|
          | **amd64** | 64-bit Intel Mac | \`darwin-amd64\` |
          | **arm64** | Apple Silicon (M1/M2/M3) | \`darwin-arm64\` |

          ## ‚ö° One-Liner Installation

          The installer automatically detects your platform and architecture:

          \`\`\`bash
          # Install both server and client
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/get.sh | bash

          # Install server only
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/get.sh | bash -s -- --server-only

          # Install client only
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/get.sh | bash -s -- --client-only

          # Install specific version
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/get.sh | bash -s -- --version ${VERSION}
          \`\`\`

          ## üì• Manual Download & Installation

          ### Auto-detect Platform & Architecture
          \`\`\`bash
          # Detect platform and architecture
          OS=\$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=\$(uname -m | sed 's/x86_64/amd64/' | sed 's/aarch64/arm64/' | sed 's/armv7l/armv7/')

          # Download server
          curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-server-\${OS}-\${ARCH}.tar.gz" | tar xz

          # Download client
          curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-client-\${OS}-\${ARCH}.tar.gz" | tar xz
          \`\`\`

          ### Linux Specific Downloads
          \`\`\`bash
          # AMD64/Intel (most common)
          curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-server-linux-amd64.tar.gz" | tar xz
          curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-client-linux-amd64.tar.gz" | tar xz

          # ARM64 (AWS Graviton, etc.)
          curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-server-linux-arm64.tar.gz" | tar xz
          curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-client-linux-arm64.tar.gz" | tar xz

          # ARMv7 (Raspberry Pi, etc.)
          curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-server-linux-armv7.tar.gz" | tar xz
          curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-client-linux-armv7.tar.gz" | tar xz
          \`\`\`

          ### macOS Specific Downloads
          \`\`\`bash
          # Intel Mac
          curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-server-darwin-amd64.tar.gz" | tar xz
          curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-client-darwin-amd64.tar.gz" | tar xz

          # Apple Silicon (M1/M2/M3)
          curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-server-darwin-arm64.tar.gz" | tar xz
          curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-client-darwin-arm64.tar.gz" | tar xz
          \`\`\`

          ## ‚úÖ Verification

          Verify downloaded files using checksums:
          \`\`\`bash
          # Download checksums
          curl -L "https://github.com/${{ github.repository }}/releases/download/${VERSION}/checksums.txt" -o checksums.txt

          # Verify files
          sha256sum -c checksums.txt
          \`\`\`

          ## üîß System Requirements

          ### Linux
          - **Operating System**: Linux (any distribution)
          - **Architecture**: x86_64 (amd64), ARM64 (aarch64), or ARMv7 (arm)
          - **Dependencies**: None (statically linked binaries)
          - **Minimum Kernel**: Linux 2.6.32+

          ### macOS
          - **Operating System**: macOS 10.15+ (Catalina or later)
          - **Architecture**: Intel (x86_64) or Apple Silicon (arm64)
          - **Dependencies**: None (statically linked binaries)

          ## üöÄ Quick Start

          1. **Install**: Use the one-liner or download manually
          2. **Configure**: Edit \`~/.config/s01/server.env\` and \`~/.config/s01/client.env\`
          3. **Run**: Execute \`s01-server-run\` and \`s01-client-run\`

          ## üìã Build Information

          - **Go Version**: ${{ env.GO_VERSION }}
          - **Build Date**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - **Git Commit**: ${{ github.sha }}
          - **CGO**: Disabled (static linking)
          - **Total Binaries**: $(find release -name "*.tar.gz" | wc -l) binaries
          - **Platforms**: Linux, macOS
          - **Architectures**: $(find release -name "*server*.tar.gz" | wc -l) architectures per platform

          ## üìö Documentation

          - [Installation Guide](https://github.com/${{ github.repository }}/blob/main/QUICK-INSTALL.md)
          - [Binary Deployment](https://github.com/${{ github.repository }}/blob/main/BINARY-DEPLOYMENT.md)
          - [Docker Usage](https://github.com/${{ github.repository }}/blob/main/DOCKER-USAGE.md)
          - [Main Documentation](https://github.com/${{ github.repository }}#readme)

          EOF

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build-matrix.outputs.version }}
          name: "s01 ${{ needs.build-matrix.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' || contains(needs.build-matrix.outputs.version, 'alpha') || contains(needs.build-matrix.outputs.version, 'beta') || contains(needs.build-matrix.outputs.version, 'rc') }}
          files: |
            release/*.tar.gz
            release/*.sha256
            release/checksums.txt
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          echo "## üéâ Multi-Architecture Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Component | Architectures | Total Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------------|------------|" >> $GITHUB_STEP_SUMMARY

          server_files=$(find release -name "s01-server-*.tar.gz" | wc -l)
          client_files=$(find release -name "s01-client-*.tar.gz" | wc -l)
          total_size=$(du -ch release/*.tar.gz 2>/dev/null | tail -1 | cut -f1 || echo "N/A")

          echo "| Server | $server_files | $(du -ch release/s01-server-*.tar.gz 2>/dev/null | tail -1 | cut -f1 || echo "N/A") |" >> $GITHUB_STEP_SUMMARY
          echo "| Client | $client_files | $(du -ch release/s01-client-*.tar.gz 2>/dev/null | tail -1 | cut -f1 || echo "N/A") |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$(($server_files + $client_files))** | **$total_size** |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release**: ${{ needs.build-matrix.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Download**: https://github.com/${{ github.repository }}/releases/tag/${{ needs.build-matrix.outputs.version }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Available Downloads" >> $GITHUB_STEP_SUMMARY
          echo "| File | Architecture | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------------|------|" >> $GITHUB_STEP_SUMMARY

          for file in release/*.tar.gz; do
            if [[ -f "$file" ]]; then
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)

              # Extract architecture from filename
              if [[ "$filename" =~ linux-([^.]+) ]]; then
                arch="${BASH_REMATCH[1]}"
              else
                arch="unknown"
              fi

              echo "| $filename | $arch | $size |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üöÄ Quick Installation Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Auto-detect architecture and install both components" >> $GITHUB_STEP_SUMMARY
          echo "curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/get.sh | bash" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Install specific version" >> $GITHUB_STEP_SUMMARY
          echo "curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/get.sh | bash -s -- --version ${{ needs.build-matrix.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Test installation on different architectures (optional)
  test-installation:
    name: Test Installation
    needs: [build-matrix, create-release]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Linux amd64 installation
        run: |
          echo "Testing Linux amd64 binary download..."
          VERSION="${{ needs.build-matrix.outputs.version }}"

          # Wait a moment for release to be available
          sleep 30

          # Test server download
          if curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-server-linux-amd64.tar.gz" | tar xz; then
            if ./s01-server --help >/dev/null 2>&1 || ./s01-server -h >/dev/null 2>&1; then
              echo "‚úÖ Linux server binary works"
            else
              echo "‚ö†Ô∏è Linux server binary downloaded but help command failed"
            fi
          else
            echo "‚ùå Failed to download Linux server binary"
            exit 1
          fi

          # Test client download
          if curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-client-linux-amd64.tar.gz" | tar xz; then
            if ./s01-client --help >/dev/null 2>&1 || ./s01-client -h >/dev/null 2>&1; then
              echo "‚úÖ Linux client binary works"
            else
              echo "‚ö†Ô∏è Linux client binary downloaded but help command failed"
            fi
          else
            echo "‚ùå Failed to download Linux client binary"
            exit 1
          fi

          echo "‚úÖ Linux AMD64 binaries tested successfully"

      - name: Verify checksums
        run: |
          VERSION="${{ needs.build-matrix.outputs.version }}"

          # Download checksums
          if curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/checksums.txt" -o checksums.txt; then
            echo "‚úÖ Checksums downloaded"
          else
            echo "‚ùå Failed to download checksums"
            exit 1
          fi

          # Download and verify Linux binary
          if curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-server-linux-amd64.tar.gz" -o s01-server-linux-amd64.tar.gz; then
            # Verify checksum
            if sha256sum -c checksums.txt --ignore-missing; then
              echo "‚úÖ Linux checksums verified successfully"
            else
              echo "‚ùå Linux checksum verification failed"
              exit 1
            fi
          else
            echo "‚ùå Failed to download Linux binary for checksum verification"
            exit 1
          fi

          # Test if macOS binaries are available and verify one
          rm -f s01-server-*.tar.gz  # Clean up Linux binary
          if curl -L "https://github.com/${{ github.repository }}/releases/download/$VERSION/s01-server-darwin-amd64.tar.gz" -o s01-server-darwin-amd64.tar.gz 2>/dev/null; then
            if sha256sum -c checksums.txt --ignore-missing; then
              echo "‚úÖ macOS checksums verified successfully"
            else
              echo "‚ö†Ô∏è macOS checksum verification failed, but binary exists"
            fi
          else
            echo "‚ÑπÔ∏è macOS binaries not found or not accessible from Linux runner"
          fi
